{% extends 'dashboard_base.html' %}
{% load static %}

{% block dashboard_title %}
    Gestión de Clasificaciones
{% endblock %}

{% block dashboard_page_title %}
    Gestión de Calificaciones
{% endblock %}

{% block dashboard_content %}

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Calificaciones Existentes</h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrear">
                    <i class="fas fa-plus me-1"></i> Crear Nueva
                </button>
            </div>
            <div class="card-body">
                
                {% if clasificaciones %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Total de Datos</th>
                                    <th>Creado por</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in clasificaciones %}
                                <tr>
                                    <td><strong>{{ item.nombre }}</strong></td>
                                    <td><span class="badge bg-info">{{ item.total_datos }}</span></td>
                                    <td>{{ item.creado_por.username|default:"Sistema" }}</td>
                                    <td class="text-end">
                                        {% if user.is_staff or item.creado_por == user %}
                                            <a href="{% url 'editar_clasificacion' item.pk %}" class="btn btn-sm btn-outline-warning" title="Editar">
                                                <i class="fas fa-edit"></i> Editar
                                            </a>
                                            <a href="{% url 'eliminar_clasificacion' item.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="return confirm('¿Estás seguro de eliminar esta clasificación?');">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </a>
                                        {% else %}
                                            <span class="text-muted" title="No tienes permisos"><i class="fas fa-lock"></i> Solo el dueño puede editar</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center p-4">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <h5 class="mb-3">No hay calificaciones</h5>
                        <p class="text-muted">Aún no has creado ninguna calificación. ¡Empieza ahora!</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrear">
                            <i class="fas fa-plus me-1"></i> Crear la primera
                        </button>
                    </div>
                {% endif %}

            </div>
        </div>
    </div>
</div> 

<div class="modal fade" id="modalCrear" tabindex="-1" aria-labelledby="modalCrearLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="modalCrearLabel">Crear Nueva Calificación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <form method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted small">Añade una nueva categoría para tus datos (ej: Renta Fija, Renta Variable).</p>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger py-2">
                            {% for error in form.non_field_errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label fw-bold">Nombre de la calificación:</label>
                        {{ form.nombre }} {% if form.nombre.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.nombre.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Guardar Calificación</button>
                </div>
            </form>

        </div>
    </div>
</div>
{% endblock %}