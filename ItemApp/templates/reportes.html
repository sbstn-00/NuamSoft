{% extends 'dashboard_base.html' %}
{% load static %}

{% block dashboard_title %}
    Reportes Analíticos
{% endblock %}

{% block dashboard_page_title %}
    <i class="fas fa-chart-bar"></i> Reporte de Concentración Tributaria
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros del Reporte</h5>
                </div>
                <div class="card-body">
                    <form method="GET" id="formReporte">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label for="id_clasificacion" class="form-label fw-semibold">Calificación:</label>
                                <select name="clasificacion" id="id_clasificacion" class="form-select">
                                    <option value="">Todas las Calificaciones</option>
                                    {# Las clasificaciones se pasan desde la vista (contexto: 'clasificaciones_list') #}
                                    {% for clas in clasificaciones_list %}
                                        <option value="{{ clas.id }}" {% if clasificacion_seleccionada == clas.id|stringformat:"s" %}selected{% endif %}>
                                            {{ clas.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-5">
                                <label for="id_fecha_inicio" class="form-label fw-semibold">Fecha de Inicio (Dato):</label>
                                <input type="date" name="fecha_inicio" id="id_fecha_inicio" class="form-control" value="{{ fecha_inicio_seleccionada|default:"" }}">
                                <small class="text-muted">Filtra los datos creados a partir de esta fecha.</small>
                            </div>

                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-search me-1"></i> Generar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card shadow-sm border-0">
                {# CAMBIO REALIZADO: Agregamos text-white al h5 para forzar el color #}
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0 **text-white**"><i class="fas fa-chart-bar me-2 text-warning"></i>Consolidación de Montos por Clasificación</h5>
                </div>
                <div class="card-body">
                    
                    {# Muestra el gráfico solo si hay datos #}
                    {% if reporte_data %}
                        {# 1. GRÁFICO #}
                        <div class="mb-5">
                            <canvas id="chartReporte" height="250"></canvas>
                        </div>

                        {# 2. TABLA DE DETALLES #}
                        <h6 class="fw-bold mt-4 mb-3"><i class="fas fa-table me-1"></i>Detalle Agrupado:</h6>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Calificación</th>
                                        <th class="text-end">Total Datos</th>
                                        <th class="text-end">Monto Total</th>
                                        <th class="text-end">Monto Promedio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in reporte_data %}
                                        <tr>
                                            <td><span class="badge bg-primary">{{ item.clasificacion__nombre }}</span></td>
                                            <td class="text-end fw-semibold">{{ item.total_datos }}</td>
                                            <td class="text-end"><strong>${{ item.monto_total|floatformat:2|default:"0.00" }}</strong></td>
                                            <td class="text-end">${{ item.monto_promedio|floatformat:2|default:"0.00" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center p-4">
                            <i class="fas fa-search fa-3x text-info mb-3"></i>
                            <h5 class="mb-2">Aplica los filtros para generar tu primer reporte.</h5>
                            <p class="mb-0">Asegúrate de que existan datos tributarios con las calificaciones seleccionadas.</p>
                        </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

{# Script para pasar datos a Chart.js (JSON Data) #}
<script id="json-reporte-data" type="application/json">
    [
        {% for item in reporte_data %}
        {
            // Usamos escapejs para manejar comillas o caracteres especiales en el nombre
            "nombre": "{{ item.clasificacion__nombre|escapejs }}",
            // Aseguramos que sea un número flotante sin formato de moneda/coma
            "monto_total": {{ item.monto_total|default:0|floatformat:2 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
</script>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        const dataElement = document.getElementById('json-reporte-data');
        if (!dataElement) return;

        // 1. Parsear los datos del JSON
        const rawReporteData = JSON.parse(dataElement.textContent.trim());

        // 2. Limpiar y validar datos:
        //    a) Filtrar elementos donde el monto_total no sea null o cero.
        //    b) Convertir el monto_total a flotante para Chart.js.
        const reporteData = rawReporteData
            .map(item => ({
                nombre: item.nombre,
                // Aseguramos que sea un número flotante, usando 0 si la conversión falla
                monto_total: parseFloat(item.monto_total) || 0
            }))
            .filter(item => item.monto_total > 0); // Solo mantener categorías con montos > 0


        if (reporteData.length === 0) {
            console.log("No hay datos válidos para generar el gráfico.");
            return;
        }

        const labels = reporteData.map(item => item.nombre);
        const data = reporteData.map(item => item.monto_total);

        // Función para generar colores únicos (sin cambios)
        const generateColors = (num) => {
            const colors = [];
            const color_base = ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#6f42c1', '#f8f9fa'];
            for(let i = 0; i < num; i++) {
                colors.push(color_base[i % color_base.length]);
            }
            return colors;
        };
        
        const backgroundColors = generateColors(labels.length);

        const ctx = document.getElementById('chartReporte').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Monto Total Tributario ($)',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Monto Total'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-CL');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Monto Tributario Consolidado por Clasificación',
                        font: { size: 16 }
                    }
                }
            }
        });
    } catch (e) {
        console.error("Error al cargar Chart.js para el reporte:", e);
    }
});
</script>
{% endblock %}
