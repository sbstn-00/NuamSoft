    {% extends 'dashboard_base.html' %}
    {% load static %}

    {% block dashboard_title %}
        Reportes Analíticos
    {% endblock %}

    {% block dashboard_page_title %}
        <i class="fas fa-chart-bar"></i> Reporte de Concentración Tributaria
    {% endblock %}

    {% block dashboard_content %}
    <div class="container-fluid">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros del Reporte</h5>
                    </div>
                    <div class="card-body">
                        <form method="GET" id="formReporte">
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label for="id_clasificacion" class="form-label fw-semibold">Calificación:</label>
                                    <select name="clasificacion" id="id_clasificacion" class="form-select">
                                        <option value="">Todas las Calificaciones</option>
                                        {% for clas in clasificaciones_list %}
                                            <option value="{{ clas.id }}" {% if clasificacion_seleccionada == clas.id|stringformat:"s" %}selected{% endif %}>
                                                {{ clas.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-5">
                                    <label for="id_fecha_inicio" class="form-label fw-semibold">Fecha de Inicio (Dato):</label>
                                    <input type="date" name="fecha_inicio" id="id_fecha_inicio" class="form-control" value="{{ fecha_inicio_seleccionada|default:"" }}">
                                    <small class="text-muted">Filtra los datos creados a partir de esta fecha.</small>
                                </div>

                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fas fa-search me-1"></i> Generar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <script id="json-reporte-data" type="application/json">
        [
            {% for item in reporte_data %}
            {
                "nombre": "{{ item.clasificacion__nombre|escapejs }}",
                {# Usamos stringformat:'f' para que salga 1200.50 (con punto) y no 1.200,50 (con coma) #}
                "monto_total": {{ item.monto_total|default:"0"|floatformat:"2"|cut:"," }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    </script>
    {% endblock %}

    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const dataElement = document.getElementById('json-reporte-data');
            if (!dataElement) return;

            const rawReporteData = JSON.parse(dataElement.textContent.trim());

        
            const reporteData = rawReporteData.map(item => ({
                nombre: item.nombre,
                monto_total: parseFloat(item.monto_total) || 0
            }));

            
            if (reporteData.length === 0) {
                console.log("No hay datos para generar el gráfico.");
                return;
            }

            const labels = reporteData.map(item => item.nombre);
            const data = reporteData.map(item => item.monto_total);

        
            const generateColors = (num) => {
                const color_base = ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#6f42c1', '#f8f9fa'];
                const colors = [];
                for(let i = 0; i < num; i++) {
                    colors.push(color_base[i % color_base.length]);
                }
                return colors;
            };
            const backgroundColors = generateColors(labels.length);

            const ctx = document.getElementById('chartReporte').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monto Total ($)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-CL');
                                }
=======

</div>



{# === AQUÍ ESTÁ LA CORRECCIÓN IMPORTANTE === #}

<script id="json-reporte-data" type="application/json">

    [

        {% for item in reporte_data %}

        {

            "nombre": "{{ item.clasificacion__nombre|escapejs }}",

            {# Usamos stringformat:'f' para que salga 1200.50 (con punto) y no 1.200,50 (con coma) #}

            "monto_total": {{ item.monto_total|default:0|stringformat:'f' }}

        }{% if not forloop.last %},{% endif %}

        {% endfor %}

    ]

</script>

{% endblock %}



{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

document.addEventListener('DOMContentLoaded', function() {

    try {

        const dataElement = document.getElementById('json-reporte-data');

        if (!dataElement) return;



        const rawReporteData = JSON.parse(dataElement.textContent.trim());



       

        const reporteData = rawReporteData.map(item => ({

            nombre: item.nombre,

            monto_total: parseFloat(item.monto_total) || 0

        }));



       

        if (reporteData.length === 0) {

            console.log("No hay datos para generar el gráfico.");

            return;

        }



        const labels = reporteData.map(item => item.nombre);

        const data = reporteData.map(item => item.monto_total);



       

        const generateColors = (num) => {

            const color_base = ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#6f42c1', '#f8f9fa'];

            const colors = [];

            for(let i = 0; i < num; i++) {

                colors.push(color_base[i % color_base.length]);

            }

            return colors;

        };

        const backgroundColors = generateColors(labels.length);



        const ctx = document.getElementById('chartReporte').getContext('2d');

        new Chart(ctx, {

            type: 'bar',

            data: {

                labels: labels,

                datasets: [{

                    label: 'Monto Total ($)',

                    data: data,

                    backgroundColor: backgroundColors,

                    borderColor: '#333',

                    borderWidth: 1

                }]

            },

            options: {

                responsive: true,

                maintainAspectRatio: false,

                scales: {

                    y: {

                        beginAtZero: true,

                        ticks: {

                            callback: function(value) {

                                return '$' + value.toLocaleString('es-CL');

>>>>>>> 5ef9f9c63c2b1988af0bd2c38d32b581118dc8c0
                            }

                        }
<<<<<<< HEAD
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$ ' + context.parsed.y.toLocaleString('es-CL');
                                }
=======

                    }

                },

                plugins: {

                    legend: { display: false },

                    tooltip: {

                        callbacks: {

                            label: function(context) {

                                return '$ ' + context.parsed.y.toLocaleString('es-CL');

>>>>>>> 5ef9f9c63c2b1988af0bd2c38d32b581118dc8c0
                            }

                        }

                    }

                }
<<<<<<< HEAD
            });
        } catch (e) {
            console.error("Error al cargar Chart.js:", e);
        }
    });
    </script>
    {% endblock %}
=======

            }

        });

    } catch (e) {

        console.error("Error al cargar Chart.js:", e);

    }

});

</script>

{% endblock %}
>>>>>>> 5ef9f9c63c2b1988af0bd2c38d32b581118dc8c0
