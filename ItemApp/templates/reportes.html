{% extends 'dashboard_base.html' %}
{% load static %}

{# ... (Contenido de tu DASHBOARD_TITLE y DASHBOARD_PAGE_TITLE) ... #}

{% block dashboard_content %}
<div class="container-fluid">
    {# ... (Bloque de mensajes y Filtros del Reporte) ... #}
    
    <div class="row">
        {# ... (Bloque de Filtros) ... #}
    
        <div class="col-lg-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0" style="color: white !important;"><i class="fas fa-chart-bar me-2" style="color: yellow !important;"></i>Consolidación de Montos por Calificación</h5>
                </div>
                <div class="card-body">
                    
                    {% if reporte_data %}
                        {# 1. GRÁFICO: Asegúrate de que el contenedor del gráfico tenga el ID correcto #}
                        <div class="mb-5" id="chartContainer" style="height: 300px;"> 
                            <canvas id="chartReporte"></canvas>
                        </div>

                        {# 2. TABLA DE DETALLES: Tu tabla con datos (Funciona OK) #}
                        <h6 class="fw-bold mt-4 mb-3"><i class="fas fa-table me-1"></i>Detalle Agrupado:</h6>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Calificación</th>
                                        <th class="text-end">Total Datos</th>
                                        <th class="text-end">Monto Total</th>
                                        <th class="text-end">Monto Promedio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# La tabla usa los datos que la vista ya preparó #}
                                    {% for item in reporte_data %}
                                        <tr>
                                            <td><span class="badge bg-primary">{{ item.clasificacion__nombre }}</span></td>
                                            <td class="text-end fw-semibold">{{ item.total_datos }}</td>
                                            <td class="text-end"><strong>${{ item.monto_total|floatformat:2|default:"0.00" }}</strong></td>
                                            <td class="text-end">${{ item.monto_promedio|floatformat:2|default:"0.00" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center p-4">
                            <i class="fas fa-search fa-3x text-info mb-3"></i>
                            <h5 class="mb-2">Aplica los filtros para generar tu primer reporte.</h5>
                            <p class="mb-0">Asegúrate de que existan datos tributarios con las calificaciones seleccionadas.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# === BLOQUE JSON (Aseguramos el float puro) === #}
<script id="json-reporte-data" type="application/json">
    [
        {% for item in reporte_data %}
        {
            "nombre": "{{ item.clasificacion__nombre|escapejs }}",
            "monto_total": {{ item.monto_total|default:0.0 }} 
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
</script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// La función generateColors estaba usando un argumento 'num' que no coincidía con 'labels.length'
// Simplificamos para usar un array fijo de colores si no hay datos complejos.
const COLOR_BASE = ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#6f42c1'];

function generateColors(count) {
    const colors = [];
    for(let i = 0; i < count; i++) {
        colors.push(COLOR_BASE[i % COLOR_BASE.length]);
    }
    return colors;
};

document.addEventListener('DOMContentLoaded', function() {
    const dataElement = document.getElementById('json-reporte-data');
    const chartCanvas = document.getElementById('chartReporte');
    const chartContainer = document.getElementById('chartContainer');

    if (!dataElement || !chartCanvas) {
        console.warn("Elemento JSON o Canvas no encontrado.");
        return;
    }

    try {
        const rawReporteData = JSON.parse(dataElement.textContent.trim());

        const reporteData = rawReporteData.map(item => ({
            nombre: item.nombre,
            // parseFloat ahora funciona correctamente con el float puro de Python
            monto_total: parseFloat(item.monto_total) || 0
        })).filter(item => item.monto_total > 0); // Solo datos con montos > 0

        
        if (reporteData.length === 0) {
            // Ocultar el contenedor del gráfico si no hay datos
            if(chartContainer) chartContainer.style.display = 'none';
            return;
        }

        const labels = reporteData.map(item => item.nombre);
        const data = reporteData.map(item => item.monto_total);
        const backgroundColors = generateColors(labels.length);

        const ctx = chartCanvas.getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Monto Total ($)',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Permite que el contenedor de 300px funcione
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-CL', { maximumFractionDigits: 0 });
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$ ' + context.parsed.y.toLocaleString('es-CL');
                            }
                        }
                    }
                }
            }
        });
    } catch (e) {
        console.error("Error al inicializar Chart.js:", e);
        // Mostrar un mensaje en la consola si el script falla
        if(chartContainer) chartContainer.innerHTML = '<div class="alert alert-danger">Error al cargar el gráfico. Verifique la consola para detalles.</div>';
    }
});
</script>
{% endblock %}