{% extends 'dashboard_base.html' %}
{% load static %}

{% block dashboard_title %}
    Panel Principal
{% endblock %}

{% block dashboard_page_title %}
    Bienvenido, {{ user.first_name|default:user.username }}
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card mb-4 shadow-sm border-0 border-primary-subtle" style="border-width: 2px;">
        <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h4 class="fw-bold mb-1"> Hola, {{ user.first_name|default:user.username }}</h4>
                <p class="text-muted mb-0">Bienvenido al panel de control de <strong>NUAM</strong>.</p>
            </div>
            <i class="fas fa-hand-sparkles fa-3x text-primary opacity-75"></i>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-primary-subtle bg-primary-subtle text-primary-emphasis h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Calificaciones</small>
                            <h2 class="fw-bold">{{ total_clasificaciones|default:"0" }}</h2>
                        </div>
                        <i class="fas fa-layer-group fa-3x text-primary opacity-25"></i>
                    </div>
                    <small><a href="{% url 'crear_clasificacion' %}" class="text-primary-emphasis text-decoration-none">Ver más</a></small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-success-subtle bg-success-subtle text-success-emphasis h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Datos Cargados</small>
                            <h2 class="fw-bold">{{ total_datos|default:"0" }}</h2>
                        </div>
                        <i class="fas fa-database fa-3x text-success opacity-25"></i>
                    </div>
                    <small><a href="{% url 'listar_datos_tributarios' %}" class="text-success-emphasis text-decoration-none">Ver más</a></small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-info-subtle bg-info-subtle text-info-emphasis h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Total Usuarios</small>
                            <h2 class="fw-bold">{{ total_usuarios|default:"0" }}</h2>
                        </div>
                        <i class="fas fa-users fa-3x text-info opacity-25"></i>
                    </div>
                    <small class="text-info-emphasis">Registrados en la plataforma</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-warning-subtle bg-warning-subtle text-warning-emphasis h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Monto Total</small>
                            <h2 class="fw-bold">${{ monto_total|floatformat:0|default:"0" }}</h2>
                        </div>
                        <i class="fas fa-dollar-sign fa-3x text-warning opacity-25"></i>
                    </div>
                    <small class="text-warning-emphasis">Suma de todos los datos</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light fw-bold"><i class="fas fa-chart-pie me-2 text-primary"></i>Distribución por Clasificación</div>
                <div class="card-body">
                    <canvas id="chartClasificaciones" height="160"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light fw-bold"><i class="fas fa-chart-line me-2 text-success"></i>Actividad Reciente</div>
                <div class="card-body">
                    <canvas id="chartActividad" height="160"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-light fw-bold"><i class="fas fa-clock me-2"></i>Últimos Datos Cargados</div>
        <div class="card-body">
            {% if datos_recientes %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Calificación</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                            <th>Creado por</th> </tr>
                    </thead>
                    <tbody>
                        {% for dato in datos_recientes %}
                        <tr>
                            <td><strong>{{ dato.nombre_dato }}</strong></td>
                            <td><span class="badge bg-info text-dark">{{ dato.clasificacion.nombre }}</span></td>
                            <td>$ {{ dato.monto|floatformat:2 }}</td>
                            <td>{{ dato.creado_en|date:"d/m/Y H:i" }}</td>
                            <td>{{ dato.creado_por.username|default:"Sistema" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-4">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h5 class="mb-3">No hay datos recientes</h5>
                <p class="text-muted">Cuando cargues datos nuevos, aparecerán aquí.</p>
                <a href="{% url 'carga_datos' %}" class="btn btn-primary">
                    <i class="fas fa-upload me-1"></i> Cargar datos ahora
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script id="json-stats-clasificacion" type="application/json">
    [
        {% for item in stats_clasificacion %}
        {
            "nombre": "{{ item.nombre }}",
            "total_datos": {{ item.total_datos|default:0 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- GRÁFICO 1: PIE (Ahora dinámico) ---
try {
    const statsData = JSON.parse(document.getElementById('json-stats-clasificacion').textContent);
    const labelsPie = statsData.map(item => item.nombre);
    const dataPie = statsData.map(item => item.total_datos);
    
    // Solo mostramos el gráfico si hay datos
    if (dataPie.length > 0) {
        const ctx1 = document.getElementById('chartClasificaciones');
        new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: labelsPie,
                datasets: [{
                    data: dataPie,
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#0dcaf0', '#fd7e14', '#6f42c1']
                }]
            },
            options: { 
                plugins: { 
                    legend: { position: 'bottom' } 
                },
                responsive: true
            }
        });
    }
} catch (e) {
    console.error("Error al parsear datos del gráfico:", e);
}


// --- GRÁFICO 2: LÍNEA (Sigue estático, no tenemos datos de serie de tiempo) ---
const ctx2 = document.getElementById('chartActividad');
new Chart(ctx2, {
    type: 'line',
    data: {
        labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie'],
        datasets: [{
            label: 'Cargas',
            data: [2, 5, 3, 7, 4],
            borderColor: '#198754',
            fill: false,
            tension: 0.3
        }]
    },
    options: { 
        scales: { 
            y: { beginAtZero: true } 
        },
        responsive: true
    }
});
</script>
{% endblock %}