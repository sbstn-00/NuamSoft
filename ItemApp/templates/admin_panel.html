{% extends 'dashboard_base.html' %}
{% load static %}

{% block dashboard_title %}
    Panel de Administración
{% endblock %}

{% block dashboard_page_title %}
    <i class="fas fa-shield-alt"></i> Panel de Administración
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Total Usuarios</h6>
                            <h3 class="mb-0">{{ total_usuarios }}</h3>
                            <small class="text-muted">
                                <i class="fas fa-user-shield"></i> {{ total_staff }} staff
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-file-invoice-dollar fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Monto Total</h6>
                            <h3 class="mb-0">${{ monto_total|floatformat:2|default:"0.00" }}</h3>
                            <small class="text-muted">
                                <i class="fas fa-chart-line"></i> Promedio: ${{ monto_promedio|floatformat:2|default:"0.00" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm border-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-folder-open fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Calificaciones</h6>
                            <h3 class="mb-0">{{ total_clasificaciones }}</h3>
                            <small class="text-muted">
                                <i class="fas fa-database"></i> {{ total_datos_tributarios }} datos
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow-sm border-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-user-check fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Registros NUAM</h6>
                            <h3 class="mb-0">{{ total_registros_nuam }}</h3>
                            <small class="text-muted">
                                <i class="fas fa-calendar-alt"></i> +{{ registros_nuevos_30d }} últimos 30 días
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Actividad Últimos 30 Días</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-plus text-success"></i> Usuarios Nuevos</span>
                                <strong class="text-success">{{ usuarios_nuevos_30d }}</strong>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-sign-in-alt text-primary"></i> Usuarios Activos</span>
                                <strong class="text-primary">{{ usuarios_activos_30d }}</strong>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-file-upload text-info"></i> Datos Nuevos</span>
                                <strong class="text-info">{{ datos_nuevos_30d }}</strong>
                            </div>
                        </li>
                        <li>
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-check text-warning"></i> Registros Nuevos</span>
                                <strong class="text-warning">{{ registros_nuevos_30d }}</strong>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign"></i> Estadísticas Financieras</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-arrow-up text-success"></i> Monto Máximo</span>
                                <strong class="text-success">${{ monto_maximo|floatformat:2|default:"0.00" }}</strong>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-arrow-down text-danger"></i> Monto Mínimo</span>
                                <strong class="text-danger">${{ monto_minimo|floatformat:2|default:"0.00" }}</strong>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-calculator text-info"></i> Factor Promedio</span>
                                <strong class="text-info">{{ factor_promedio|floatformat:4|default:"0.0000" }}</strong>
                            </div>
                        </li>
                        <li>
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-database text-primary"></i> Total Datos</span>
                                <strong class="text-primary">{{ total_datos_tributarios }}</strong>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-users-cog"></i> Permisos del Sistema</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-shield text-primary"></i> Usuarios Staff</span>
                                <strong class="text-primary">{{ total_staff }}</strong>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-crown text-warning"></i> Superusuarios</span>
                                <strong class="text-warning">{{ total_superusuarios }}</strong>
                            </div>
                        </li>
                        <li>
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user text-secondary"></i> Usuarios Regulares</span>
                                <strong class="text-secondary">{{ total_usuarios_regulares }}</strong>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

   
    <div class="row mb-4">
       
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Usuarios Recientes</h5>
                    <a href="/admin/auth/user/" class="btn btn-sm btn-light" target="_blank">
                        <i class="fas fa-external-link-alt"></i> Ver Todos
                    </a>
                </div>
                <div class="card-body">
                    {% if usuarios_recientes %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Email</th>
                                        <th>Staff</th>
                                        <th>Registro</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for usuario in usuarios_recientes %}
                                    <tr>
                                        <td>
                                            <strong>{{ usuario.username }}</strong>
                                            {% if usuario.is_superuser %}
                                                <span class="badge bg-warning"><i class="fas fa-crown"></i></span>
                                            {% elif usuario.is_staff %}
                                                <span class="badge bg-info"><i class="fas fa-user-shield"></i></span>
                                            {% endif %}
                                        </td>
                                        <td>{{ usuario.email|default:"-" }}</td>
                                        <td>
                                            {% if usuario.is_staff %}
                                                <span class="badge bg-success">Sí</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </td>
                                        <td><small>{{ usuario.date_joined|date:"d/m/Y" }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No hay usuarios registrados.</p>
                    {% endif %}
                </div>
            </div>
        </div>

       
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user-check"></i> Registros NUAM Recientes</h5>
                    <a href="/admin/ItemApp/registronuam/" class="btn btn-sm btn-light" target="_blank">
                        <i class="fas fa-external-link-alt"></i> Ver Todos
                    </a>
                </div>
                <div class="card-body">
                    {% if registros_recientes %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>País</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for registro in registros_recientes %}
                                    <tr>
                                        <td><strong>{{ registro.nombre_completo }}</strong></td>
                                        <td>{{ registro.email }}</td>
                                        <td><span class="badge bg-secondary">{{ registro.get_pais_display }}</span></td>
                                        <td><small>{{ registro.creado_en|date:"d/m/Y" }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No hay registros NUAM.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    
    <div class="row mb-4">
     
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-globe-americas"></i> Registros por País</h5>
                </div>
                <div class="card-body">
                    {% if stats_paises %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>País</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in stats_paises %}
                                    <tr>
                                        <td>
                                            {% if stat.pais == 'chile' %}Chile
                                            {% elif stat.pais == 'colombia' %}Colombia
                                            {% elif stat.pais == 'peru' %}Perú
                                            {% elif stat.pais == 'argentina' %}Argentina
                                            {% elif stat.pais == 'mexico' %}México
                                            {% elif stat.pais == 'brasil' %}Brasil
                                            {% elif stat.pais == 'ecuador' %}Ecuador
                                            {% elif stat.pais == 'venezuela' %}Venezuela
                                            {% elif stat.pais == 'uruguay' %}Uruguay
                                            {% elif stat.pais == 'paraguay' %}Paraguay
                                            {% elif stat.pais == 'bolivia' %}Bolivia
                                            {% else %}{{ stat.pais|title }}
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-success">{{ stat.total }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No hay estadísticas por país disponibles.</p>
                    {% endif %}
                </div>
            </div>
        </div>

       
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-folder"></i> Estadísticas por Calificación</h5>
                    <a href="{% url 'crear_clasificacion' %}" class="btn btn-sm btn-light">
                        <i class="fas fa-plus"></i> Nueva
                    </a>
                </div>
                <div class="card-body">
                    {% if stats_clasificacion %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Calificación</th>
                                        <th class="text-end">Datos</th>
                                        <th class="text-end">Monto Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in stats_clasificacion %}
                                    <tr>
                                        <td><strong>{{ stat.nombre }}</strong></td>
                                        <td class="text-end">
                                            <span class="badge bg-info">{{ stat.total_datos }}</span>
                                        </td>
                                        <td class="text-end">
                                            <strong>${{ stat.monto_total|floatformat:2|default:"0.00" }}</strong>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No hay calificaciones con datos.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

   
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-invoice-dollar"></i> Datos Tributarios Recientes</h5>
                    <div>
                        <a href="{% url 'listar_datos_tributarios' %}" class="btn btn-sm btn-light me-2">
                            <i class="fas fa-list"></i> Ver Todos
                        </a>
                        <a href="{% url 'carga_datos' %}" class="btn btn-sm btn-light">
                            <i class="fas fa-upload"></i> Cargar Datos
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if datos_recientes %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Calificación</th>
                                        <th class="text-end">Monto</th>
                                        <th class="text-end">Factor</th>
                                        <th>Fecha Dato</th>
                                        <th>Creado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dato in datos_recientes %}
                                    <tr>
                                        <td><strong>{{ dato.nombre_dato }}</strong></td>
                                        <td><span class="badge bg-primary">{{ dato.clasificacion.nombre }}</span></td>
                                        <td class="text-end">${{ dato.monto|floatformat:2|default:"-" }}</td>
                                        <td class="text-end">{{ dato.factor|floatformat:4|default:"-" }}</td>
                                        <td>{{ dato.fecha_dato|date:"d/m/Y"|default:"-" }}</td>
                                        <td><small>{{ dato.creado_en|date:"d/m/Y H:i" }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No hay datos tributarios registrados.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Accesos Rápidos</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="/admin/" class="btn btn-outline-primary w-100" target="_blank">
                                <i class="fas fa-cog"></i><br>
                                Django Admin
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="/admin/auth/user/" class="btn btn-outline-primary w-100" target="_blank">
                                <i class="fas fa-users"></i><br>
                                Gestionar Usuarios
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="/admin/ItemApp/registronuam/" class="btn btn-outline-info w-100" target="_blank">
                                <i class="fas fa-user-check"></i><br>
                                Registros NUAM
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{% url 'crear_clasificacion' %}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-folder-plus"></i><br>
                                Nueva Calificación
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{% url 'carga_datos' %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-upload"></i><br>
                                Cargar Datos
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="{% url 'listar_datos_tributarios' %}" class="btn btn-outline-danger w-100">
                                <i class="fas fa-list"></i><br>
                                Ver Datos Tributarios
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="/admin/ItemApp/clasificacion/" class="btn btn-outline-secondary w-100" target="_blank">
                                <i class="fas fa-folder"></i><br>
                                Gestionar Calificaciones
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a href="/admin/ItemApp/datotributario/" class="btn btn-outline-secondary w-100" target="_blank">
                                <i class="fas fa-database"></i><br>
                                Gestionar Datos
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

