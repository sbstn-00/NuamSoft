{% extends 'dashboard_base.html' %}
{% load static %}

{% block dashboard_title %}Carga Masiva de Datos{% endblock %}
{% block dashboard_page_title %}Carga Masiva de Datos{% endblock %}

{% block dashboard_content %}
<div class="container py-4">
    <div class="col-lg-10 offset-lg-1 fade-in">

        <!-- DESCARGA PLANTILLA -->
        <div class="card glass-card border-0 shadow-sm mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="fw-bold mb-1"><i class="fas fa-file-download text-primary me-2"></i>¬øNecesitas una plantilla?</h6>
                    <p class="text-muted mb-0 small">Descarga un Excel de ejemplo con el formato correcto</p>
                </div>
                <a href="{% url 'descargar_plantilla' %}" class="btn btn-outline-primary">
                    <i class="fas fa-file-excel me-2"></i>Descargar
                </a>
            </div>
        </div>


        <div class="card glass-card shadow-sm border-0 mb-4">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(90deg, #007bff, #00b4d8);">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Cargar Archivo de Datos Tributarios</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="formCarga" class="fade-in">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-triangle-exclamation me-2"></i> Corrige los errores antes de continuar.
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-folder me-2 text-secondary"></i>{{ form.clasificacion.label }}
                            </label>
                            {{ form.clasificacion }}
                            {% if form.clasificacion.errors %}
                                <div class="text-danger small">{{ form.clasificacion.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-cog me-2 text-secondary"></i>{{ form.modo_carga.label }}
                            </label>
                            <div class="mt-2">
                                {% for choice in form.modo_carga %}
                                    <div class="form-check">
                                        {{ choice.tag }}
                                        <label class="form-check-label">{{ choice.choice_label }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-file-excel me-2 text-secondary"></i>{{ form.archivo_masivo.label }}
                        </label>
                        <div class="input-group">
                            {{ form.archivo_masivo }}
                        </div>
                        <div id="fileInfo" class="text-muted small mt-2" style="display:none;"></div>

                        <div class="progress mt-3" id="progressBar" style="display:none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Procesar y Cargar Datos
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ESTAD√çSTICAS -->
        {% if total_datos > 0 %}
        <div class="card glass-card shadow-sm border-0 mt-4 fade-in">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Resumen de Cargas</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-semibold mb-0 text-success">{{ total_datos }} datos cargados</h5>
                    <a href="{% url 'listar_datos_tributarios' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i>Ver Detalles
                    </a>
                </div>
                
                {% if ultimas_cargas %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Clasificaci√≥n</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dato in ultimas_cargas %}
                            <tr>
                                <td>{{ dato.nombre_dato|truncatewords:3 }}</td>
                                <td><span class="badge bg-info text-dark">{{ dato.clasificacion.nombre }}</span></td>
                                <td>$ {{ dato.monto|floatformat:2|default:"-" }}</td>
                                <td>{{ dato.creado_en|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- AYUDA -->
        <div class="row mt-4">
            <div class="col-md-6 fade-in">
                <div class="card border-0 shadow-sm bg-light">
                    <div class="card-header bg-info text-white"><i class="fas fa-info-circle me-2"></i>Instrucciones</div>
                    <div class="card-body small">
                        <ul>
                            <li><strong>Columna ‚ÄúNombre‚Äù:</strong> Obligatoria.</li>
                            <li><strong>Columna ‚ÄúMonto‚Äù:</strong> Opcional.</li>
                            <li><strong>Columna ‚ÄúFactor‚Äù:</strong> Opcional.</li>
                            <li><strong>Tama√±o m√°ximo:</strong> 10MB</li>
                            <li><strong>Formato:</strong> Excel o CSV con encabezado</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-6 fade-in">
                <div class="card border-0 shadow-sm bg-light">
                    <div class="card-header bg-success text-white"><i class="fas fa-lightbulb me-2"></i>Consejos</div>
                    <div class="card-body small">
                        <ul>
                            <li>Usa el modo "Actualizar" para modificar datos existentes.</li>
                            <li>Descarga la plantilla para evitar errores.</li>
                            <li>Evita filas vac√≠as o encabezados duplicados.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Mostrar barra de progreso y previsualizaci√≥n
document.getElementById('formCarga').addEventListener('submit', function() {
    document.getElementById('progressBar').style.display = 'block';
    document.getElementById('btnSubmit').disabled = true;
    document.getElementById('btnSubmit').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
});

document.querySelector('input[type="file"]').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const info = `üìÑ <strong>${file.name}</strong> (${(file.size / 1024).toFixed(1)} KB)`;
        document.getElementById('fileInfo').innerHTML = info;
        document.getElementById('fileInfo').style.display = 'block';
    }
});
</script>
{% endblock %}
